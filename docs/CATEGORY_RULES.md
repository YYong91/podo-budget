# 카테고리 분류 규칙 (Category Classification Rules)

> Claude API가 자연어 지출 입력을 자동으로 카테고리 분류하기 위한 규칙 문서

## 문서 정보
- **버전**: 1.0.0
- **대상 모델**: Claude 3.5 Sonnet (Haiku도 호환 가능)
- **갱신 주기**: 월 1회 + 사용자 피드백 기반 수시 개선

---

## 1. 카테고리 체계 (Category Hierarchy)

### 대분류 (Primary Categories)

| ID | 대분류 | 설명 | 월 평균 지출 (추정) |
|----|--------|------|---------------------|
| 1 | 🍽️ 식비 | 식사, 간식, 음료 구매 | 40만원 |
| 2 | 🚇 교통 | 대중교통, 택시, 주차, 주유 | 10만원 |
| 3 | 🏠 주거 | 월세, 관리비, 인터넷, 가스, 전기, 수도 | 50만원 |
| 4 | 🛍️ 쇼핑 | 의류, 화장품, 생필품, 전자기기 | 20만원 |
| 5 | 🏥 의료 | 병원, 약국, 건강검진, 영양제 | 5만원 |
| 6 | 🎬 문화 | 영화, 공연, 책, OTT 구독 | 8만원 |
| 7 | 💪 자기계발 | 교육, 강의, 헬스장, 자격증 | 15만원 |
| 8 | 🎉 여가 | 여행, 취미, 게임, 술/유흥 | 12만원 |
| 9 | 💰 금융 | 보험, 적금, 대출 이자, 카드 연회비 | 30만원 |
| 10 | 🔧 기타 | 위 카테고리에 해당하지 않는 지출 | 5만원 |

### 중분류 (Sub-Categories)

#### 1. 🍽️ 식비 (Food & Beverage)
- **외식**: 식당, 배달음식, 패스트푸드
- **카페**: 커피, 디저트, 베이커리
- **장보기**: 마트, 시장, 편의점 식재료
- **간식**: 과자, 음료, 아이스크림
- **술**: 맥주, 소주, 와인 (혼자 구매 시)

#### 2. 🚇 교통 (Transportation)
- **대중교통**: 지하철, 버스, 티머니 충전
- **택시**: 일반 택시, 카카오택시, 우버
- **주차**: 주차비, 주차장 정기권
- **주유**: 휘발유, 경유, LPG, 전기차 충전
- **자동차**: 보험, 세금, 정비, 세차, 톨게이트

#### 3. 🏠 주거 (Housing)
- **월세**: 월세, 관리비
- **공과금**: 전기, 가스, 수도
- **통신**: 인터넷, 휴대폰 요금
- **가구**: 가구, 가전, 인테리어
- **수리**: 보일러, 배관, 도배, 방역

#### 4. 🛍️ 쇼핑 (Shopping)
- **의류**: 옷, 신발, 가방, 액세서리
- **화장품**: 스킨케어, 메이크업, 향수
- **생필품**: 세제, 휴지, 샴푸, 칫솔
- **전자기기**: 스마트폰, 노트북, 이어폰, 충전기
- **온라인쇼핑**: 쿠팡, 11번가, G마켓, 무신사

#### 5. 🏥 의료 (Healthcare)
- **병원**: 진료비, 검사비, 수술비
- **약국**: 처방약, 일반약, 비타민
- **건강검진**: 종합검진, 치과 정기검진
- **의료기기**: 안경, 렌즈, 보청기

#### 6. 🎬 문화 (Culture & Entertainment)
- **영화**: 영화관 티켓, IPTV VOD
- **공연**: 콘서트, 뮤지컬, 연극, 전시회
- **책**: 종이책, 전자책, 오디오북
- **OTT**: 넷플릭스, 웨이브, 디즈니+, 유튜브 프리미엄
- **음악**: 멜론, 스포티파이, 애플뮤직

#### 7. 💪 자기계발 (Self-Development)
- **교육**: 학원, 과외, 온라인 강의, 유데미
- **헬스**: 헬스장, 필라테스, 요가, PT
- **자격증**: 응시료, 교재, 인강
- **외국어**: 영어 회화, 토익, 듀오링고 프리미엄

#### 8. 🎉 여가 (Leisure)
- **여행**: 숙박, 항공, 투어, 렌터카
- **취미**: 사진, 악기, 등산, 낚시 장비
- **게임**: 스팀, 플스 게임, 인앱 결제
- **술/유흥**: 술집, 클럽, 노래방, 당구장
- **애완동물**: 사료, 병원, 미용

#### 9. 💰 금융 (Finance)
- **보험**: 실손, 연금, 자동차, 생명보험료
- **적금**: 정기 적금, 청약 통장
- **대출**: 주택담보, 신용대출 이자
- **카드**: 연회비, 해외 결제 수수료
- **송금**: 해외 송금 수수료

#### 10. 🔧 기타 (Miscellaneous)
- **경조사**: 축의금, 부의금
- **기부**: 정기 후원, 일회성 기부
- **벌금**: 과태료, 범칙금
- **분류 불가**: 정말 알 수 없는 지출

---

## 2. 키워드 매핑 (Keyword Mapping)

### 식비 키워드 (50+ examples)

#### 외식
```
김치찌개, 삼겹살, 치킨, 피자, 햄버거, 스테이크, 초밥, 라면, 파스타, 쌀국수
떡볶이, 순대, 김밥, 족발, 보쌈, 회, 샤브샤브, 곱창, 막창, 닭갈비
배달의민족, 요기요, 쿠팡이츠, 맥도날드, 버거킹, KFC, 롯데리아, 백종원
점심, 저녁, 아침, 식사, 밥, 먹었어, 외식, 회식, 저녁 모임
```

#### 카페
```
커피, 아메리카노, 라떼, 카페라떼, 카푸치노, 에스프레소, 프라푸치노
스타벅스, 투썸, 이디야, 메가커피, 빽다방, 탐앤탐스, 할리스, 폴바셋
케이크, 마카롱, 크루아상, 베이글, 스콘, 디저트, 빵
```

#### 장보기
```
마트, 이마트, 홈플러스, 롯데마트, 코스트코, 다이소
채소, 고기, 생선, 과일, 우유, 계란, 쌀, 김치
편의점, GS25, CU, 세븐일레븐, 미니스톱
```

### 교통 키워드

#### 대중교통
```
지하철, 버스, 전철, 환승, 티머니, 캐시비, 교통카드 충전
1호선, 2호선, 신분당선, 경의선, 공항철도
```

#### 택시
```
택시, 카카오택시, 우버, 타다, T맵택시, 기사님
```

#### 주유
```
주유, 주유소, GS칼텍스, SK에너지, 현대오일뱅크, S-OIL
휘발유, 경유, LPG, 충전, 전기차
```

### 주거 키워드

```
월세, 관리비, 전기세, 가스비, 수도세, 인터넷, 와이파이
SK브로드밴드, KT, LG유플러스, 통신비
보일러, 에어컨, 수리, 고장, AS
```

### 쇼핑 키워드

#### 의류
```
옷, 바지, 티셔츠, 재킷, 원피스, 치마, 코트, 패딩
신발, 운동화, 구두, 샌들, 스니커즈, 나이키, 아디다스
가방, 백팩, 크로스백, 지갑, 벨트
무신사, 에이블리, 지그재그, 브랜디, W컨셉
```

#### 화장품
```
스킨, 로션, 토너, 에센스, 크림, 선크림
립스틱, 파운데이션, 쿠션, 마스카라, 아이라이너
올리브영, 랄라블라, 시세이도, 설화수, 에스티로더
```

#### 전자기기
```
아이폰, 갤럭시, 맥북, 아이패드, 에어팟, 갤럭시버즈
충전기, 케이블, 어댑터, 보조배터리, 마우스, 키보드
애플, 삼성, LG, 쿠팡, 다나와, 네이버 쇼핑
```

### 의료 키워드

```
병원, 약국, 처방전, 약, 링거, 주사, 수술
감기, 몸살, 두통, 복통, 알레르기, 피부과, 치과, 정형외과
한의원, 침, 뜸, 부항
안경, 렌즈, 콘택트렌즈, 안과
```

### 문화 키워드

```
영화, CGV, 롯데시네마, 메가박스, 팝콘, IMAX
콘서트, 뮤지컬, 전시회, 미술관, 박물관, 인터파크, 멜론티켓
책, 교보문고, 예스24, 알라딘, 리디북스
넷플릭스, 웨이브, 티빙, 디즈니플러스, 왓챠, 쿠팡플레이
멜론, 스포티파이, 애플뮤직, 유튜브 프리미엄
```

### 자기계발 키워드

```
학원, 과외, 인강, 유데미, 인프런, 노마드코더
헬스장, 헬스, PT, 필라테스, 요가, 수영, 크로스핏
토익, 토플, 오픽, 자격증, 운전면허, 산업기사
```

### 여가 키워드

```
호텔, 펜션, 에어비앤비, 숙소, 항공권, 티웨이, 제주항공
여행, 제주도, 부산, 강릉, 속초, 해외여행
노래방, 당구, PC방, 방탈출, VR, 보드게임
강아지, 고양이, 사료, 간식, 동물병원, 펫샵
```

### 금융 키워드

```
보험료, 실손보험, 운전자보험, 암보험, 연금저축
적금, 청약, 예금, 저축, 투자
대출, 이자, 할부, 카드값, 연회비
```

---

## 3. 분류 알고리즘 (Classification Algorithm)

### Phase 1: 키워드 기반 초기 분류

1. **사용자 입력 정규화**
   - 공백 제거, 소문자 변환 (영문의 경우)
   - "먹었어", "샀어", "갔어" 같은 동사 제거
   - 금액 표현 ("8000원", "8천원", "만원") 추출 및 제거

2. **키워드 매칭**
   - 입력 텍스트에서 위 키워드 리스트와 부분 일치 검사
   - 매칭된 키워드 개수가 가장 많은 카테고리 선택
   - 예: "스타벅스에서 아메리카노" → [식비/카페] 2개 키워드 매칭

3. **브랜드/상호명 우선 순위**
   - "스타벅스", "CGV", "올리브영" 같은 고유명사 등장 시 해당 카테고리 확정
   - 예: "CGV 팝콘" → [문화/영화] 확정 (식비 아님)

### Phase 2: Claude API 컨텍스트 분류

키워드 매칭만으로 불충분한 경우 Claude에게 다음 프롬프트로 요청:

```
당신은 한국인의 가계부 카테고리 분류 전문가입니다.
사용자가 입력한 지출 내역을 보고 가장 적절한 카테고리를 선택하세요.

**입력**: "{raw_input}"
**추출된 정보**:
- 금액: {amount}원
- 날짜: {date}
- 설명: {description}

**카테고리 목록** (대분류 → 중분류):
1. 식비 → 외식, 카페, 장보기, 간식, 술
2. 교통 → 대중교통, 택시, 주차, 주유, 자동차
3. 주거 → 월세, 공과금, 통신, 가구, 수리
4. 쇼핑 → 의류, 화장품, 생필품, 전자기기, 온라인쇼핑
5. 의료 → 병원, 약국, 건강검진, 의료기기
6. 문화 → 영화, 공연, 책, OTT, 음악
7. 자기계발 → 교육, 헬스, 자격증, 외국어
8. 여가 → 여행, 취미, 게임, 술/유흥, 애완동물
9. 금융 → 보험, 적금, 대출, 카드, 송금
10. 기타 → 경조사, 기부, 벌금, 분류 불가

**판단 기준**:
- 구매 장소나 상호명이 가장 중요함 (예: "CGV"면 문화)
- 금액이 특정 카테고리를 암시하는 경우 고려 (예: 50만원 → 월세 가능성)
- 시간 정보 활용 (예: "점심" → 식비/외식)
- 애매하면 한국 직장인의 일반적 소비 패턴 기반으로 추론

**응답 형식** (JSON):
{
  "category_primary": "식비",
  "category_sub": "외식",
  "confidence": 0.95,
  "reasoning": "김치찌개는 한국 음식점 메뉴이고, 점심 시간대 지출이므로 외식으로 분류"
}

**중요**: confidence가 0.7 미만이면 사용자에게 확인 요청이 필요합니다.
```

### Phase 3: 사용자 확인 및 학습

1. **확신도 낮은 경우 (< 0.7)**
   - 봇 메시지: "8000원 지출을 [식비/외식]으로 분류했는데 맞나요? 아니면 [쇼핑/생필품]인가요?"
   - 사용자 선택 → DB 저장 + 피드백 로그 기록

2. **사용자 수정 시**
   - 수정된 케이스를 `category_feedback` 테이블에 저장
   - 주간 배치로 수정 패턴 분석 → 키워드 리스트 업데이트

3. **재학습 (Optional, Post-MVP)**
   - 100건 이상 피드백 쌓이면 Fine-tuning 데이터로 활용
   - Claude 프롬프트에 Few-shot 예시 추가

---

## 4. 엣지 케이스 처리 (Edge Cases)

### Case 1: 여러 카테고리 혼재
**입력**: "마트에서 삼겹살이랑 양파랑 샴푸 샀어, 총 3만원"

**처리 방식**:
- Claude에게 "여러 카테고리 포함 가능, 분리 가능하면 분리" 지시
- 가능하면 → [식비/장보기 2만원 + 쇼핑/생필품 1만원] 각각 저장
- 불가능하면 → [식비/장보기 3만원]으로 통합 (식비 비중 큼)

**예상 응답**:
```json
{
  "items": [
    {"category_primary": "식비", "category_sub": "장보기", "amount": 20000, "description": "삼겹살, 양파"},
    {"category_primary": "쇼핑", "category_sub": "생필품", "amount": 10000, "description": "샴푸"}
  ]
}
```

### Case 2: 금액 없음
**입력**: "점심 먹었어"

**처리 방식**:
- 봇 응답: "얼마 쓰셨나요? 예: 8000원"
- 사용자가 금액 입력 후 저장
- (Optional) 평균 금액 추천: "점심은 보통 8000~12000원이에요"

### Case 3: 날짜 모호함
**입력**: "지난주 토요일에 영화 봤어, 15000원"

**처리 방식**:
- Claude가 오늘 날짜 기준으로 계산 (예: 오늘 2/12 수요일 → 지난주 토요일 = 2/8)
- 봇 확인: "2월 8일(토) 맞나요?"

### Case 4: 구어체/줄임말
**입력**: "ㅋㅋ 치맥 5만원 ㄱㄱ"

**처리 방식**:
- 자음만 있는 것 ("ㅋㅋ", "ㄱㄱ") 제거
- "치맥" = 치킨 + 맥주 → [식비/외식 또는 여가/술유흥]
- 금액이 크면 [여가/술유흥] (여러 명 모임 추정)

### Case 5: 영수증 사진 (P2)
**입력**: 편의점 영수증 이미지

**처리 방식**:
- OCR로 텍스트 추출: "GS25 / 삼각김밥 1500 / 바나나우유 1800 / 합계 3300"
- 상호명 "GS25" → [식비/간식] 자동 분류
- 봇 확인: "GS25에서 3300원 지출, 식비/간식으로 저장할까요?"

### Case 6: 정기 결제 (구독)
**입력**: "넷플릭스 13500원"

**처리 방식**:
- [문화/OTT] 분류
- 매월 같은 금액 감지 시 → "매월 자동 입력할까요?" 제안
- (Post-MVP) 구독 관리 기능 추가

### Case 7: 환불/취소
**입력**: "어제 산 옷 환불받았어, 5만원"

**처리 방식**:
- MVP에서는 음수 금액으로 저장: `-50000원`
- 카테고리는 원래 지출과 동일하게 [쇼핑/의류]
- Post-MVP: 환불 플래그 추가

### Case 8: 외화 결제
**입력**: "뉴욕에서 저녁 50달러"

**처리 방식**:
- Claude가 환율 추정 불가 → 사용자에게 확인
- 봇: "환율 적용해서 원화로 입력해주세요. (예: 65000원)"
- (Post-MVP) 실시간 환율 API 연동

---

## 5. 금액 패턴 인식 (Amount Pattern Recognition)

특정 금액 범위가 카테고리를 강하게 암시하는 경우:

| 금액 범위 | 추정 카테고리 | 근거 |
|-----------|---------------|------|
| 40~60만원 | 주거/월세 | 원룸 평균 월세 |
| 1~3만원, 주유소 키워드 | 교통/주유 | 일반적인 1회 주유 금액 |
| 1만원 이하, 식사 시간대 | 식비/외식 | 한끼 평균 |
| 5천~8천원, 카페 키워드 | 식비/카페 | 커피 평균 가격 |
| 10~20만원, 의류 키워드 | 쇼핑/의류 | 옷 한 벌 평균 |
| 5~10만원, 미용실/헤어 키워드 | 쇼핑/미용 (기타) | 커트+염색 평균 |
| 100만원 이상 | 주거/가구 or 쇼핑/전자기기 | 대형 구매 |

**활용 방식**:
- 키워드 매칭과 금액 패턴을 조합해서 확신도 상승
- 예: "45만원" + "월세" 키워드 없어도 → [주거/월세] 가능성 70%

---

## 6. 다국어 지원 (Post-MVP)

현재는 한국어만 지원하지만, 향후 확장 시:

### 영어 키워드 매핑 예시
```
Food: lunch, dinner, coffee, starbucks, pizza, burger
Transportation: subway, taxi, uber, gas, parking
Shopping: clothes, shoes, amazon, ebay
```

### 혼용 입력 처리
**입력**: "스타벅스에서 venti latte 6500원"
- "스타벅스" (한국어) + "venti latte" (영어) → [식비/카페]

---

## 7. 프롬프트 최적화 (Prompt Engineering Tips)

### Few-shot 예시 포함
```
**예시**:
입력: "점심에 김치찌개 8000원"
→ {"category_primary": "식비", "category_sub": "외식", "confidence": 0.95}

입력: "CGV 어벤저스 15000원"
→ {"category_primary": "문화", "category_sub": "영화", "confidence": 0.98}

입력: "쿠팡에서 휴지 2만원"
→ {"category_primary": "쇼핑", "category_sub": "생필품", "confidence": 0.90}
```

### Chain-of-Thought 유도
```
**추론 과정을 단계별로 설명하세요**:
1. 키워드 추출: {키워드 리스트}
2. 상호명 확인: {브랜드명 있으면 명시}
3. 금액 범위 고려: {금액이 암시하는 카테고리}
4. 최종 판단: {선택한 카테고리 + 근거}
```

### Confidence Threshold 설정
- 0.9 이상: 자동 저장
- 0.7~0.9: 자동 저장 + 수정 가능 UI 강조
- 0.7 미만: 사용자 확인 필수

---

## 8. 데이터 구조 (Database Schema)

### categories 테이블
```sql
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name_primary VARCHAR(50) NOT NULL,     -- 대분류 (예: 식비)
    name_sub VARCHAR(50),                   -- 중분류 (예: 외식)
    emoji VARCHAR(10),                       -- 이모지 (예: 🍽️)
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### expenses 테이블 (기존)
```sql
-- category_id는 categories.id FK
-- raw_input: 사용자 원본 입력
-- description: Claude가 정제한 설명
-- confidence: AI 분류 확신도 (0.0~1.0)
```

### category_feedback 테이블 (피드백 학습용, Post-MVP)
```sql
CREATE TABLE category_feedback (
    id SERIAL PRIMARY KEY,
    expense_id INT REFERENCES expenses(id),
    original_category_id INT REFERENCES categories(id),  -- AI가 선택한 카테고리
    corrected_category_id INT REFERENCES categories(id), -- 사용자가 수정한 카테고리
    raw_input TEXT,                                       -- 원본 입력 (재학습용)
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 9. 테스트 케이스 (Test Cases)

### 정상 케이스 (Happy Path)
| 입력 | 예상 카테고리 | 확신도 |
|------|---------------|--------|
| 점심에 김치찌개 8000원 | 식비/외식 | 0.95 |
| 스타벅스 아메리카노 4500원 | 식비/카페 | 0.98 |
| 지하철 1500원 | 교통/대중교통 | 0.99 |
| CGV 어벤저스 15000원 | 문화/영화 | 0.98 |
| 쿠팡에서 휴지 2만원 | 쇼핑/생필품 | 0.90 |
| 넷플릭스 13500원 | 문화/OTT | 0.95 |
| 월세 45만원 | 주거/월세 | 0.92 |

### 엣지 케이스
| 입력 | 예상 동작 |
|------|-----------|
| 치킨이랑 맥주 5만원 | 식비/외식 OR 여가/술유흥 (확인 요청) |
| 마트에서 장봤어 (금액 없음) | 봇: "얼마 쓰셨나요?" |
| 어제 영화 봤어 (날짜 모호) | 봇: "어제 2월 11일 맞나요?" |
| ㅋㅋ 택시비 2만원 ㄱㄱ | 교통/택시 (자음 제거 후 처리) |
| 친구 결혼 축의금 10만원 | 기타/경조사 |
| 옷 환불받음 5만원 | 쇼핑/의류 (음수 금액) |

---

## 10. 성능 최적화 (Performance Optimization)

### 캐싱 전략
- 같은 입력 반복 시 (예: "스타벅스 아메리카노") → Redis 캐시에서 즉시 반환
- 캐시 키: `category:hash(raw_input)`
- TTL: 30일

### Rate Limiting
- Claude API 비용 절감 위해 키워드 매칭 우선 시도
- 키워드만으로 확신도 0.8 이상이면 Claude 호출 skip

### Batch Processing
- 여러 지출 동시 입력 시 ("점심 8천원, 커피 5천원, 택시 2만원")
- Claude에 한 번에 요청 (토큰 절약)

---

## 11. 모니터링 지표 (Monitoring Metrics)

### 분류 정확도
- **목표**: 사용자 수정률 15% 이하 (= 정확도 85%)
- **측정**: `(수정된 건수 / 총 지출 건수) * 100`

### AI 응답 시간
- **목표**: 평균 1.5초 이내
- **측정**: Claude API 호출 시작~응답 완료 시간

### 확신도 분포
- 0.9 이상: 60%
- 0.7~0.9: 30%
- 0.7 미만: 10% (사용자 확인 필요)

### 카테고리 사용 빈도 (Top 5 예상)
1. 식비/외식 (35%)
2. 식비/카페 (15%)
3. 교통/대중교통 (10%)
4. 쇼핑/온라인쇼핑 (8%)
5. 주거/월세 (5%)

---

## 12. 업데이트 로그 (Update History)

- **2026-02-12**: v1.0.0 초안 작성
  - 대분류 10개, 중분류 40개 정의
  - 키워드 매핑 50+ 추가
  - Claude 프롬프트 템플릿 작성
  - 엣지 케이스 8가지 정의

---

## 다음 단계 (Next Steps)

1. **카테고리 초기 데이터 생성**: `categories` 테이블에 10개 대분류 + 40개 중분류 INSERT
2. **Claude 프롬프트 테스트**: 실제 입력 50건으로 분류 정확도 검증
3. **키워드 사전 확장**: 사용자 피드백 받으며 키워드 100개까지 확대
4. **A/B 테스트**: 키워드 우선 vs Claude 우선 방식 비교 (비용 vs 정확도)

---

## 참고 자료
- [Claude Prompt Engineering Guide](https://docs.anthropic.com/claude/docs/prompt-engineering)
- [한국 통계청 가계동향조사 (2025)](https://kostat.go.kr/) - 카테고리별 평균 지출 참고
