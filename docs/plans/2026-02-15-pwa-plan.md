# PWA 설정 구현 계획

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** HomeNRich 프론트엔드를 PWA로 전환하여 홈 화면 추가, 오프라인 앱 셸, 자동 업데이트 지원

**Architecture:** `vite-plugin-pwa`로 Service Worker(generateSW 모드) + Web App Manifest 자동 생성. 앱 셸 프리캐싱 + API 런타임 캐싱(NetworkFirst). 자동 업데이트.

**Tech Stack:** vite-plugin-pwa, Workbox, @vite-pwa/assets-generator

---

### Task 1: 의존성 설치

**Files:**
- Modify: `frontend/package.json`

**Step 1: vite-plugin-pwa 설치**

Run:
```bash
cd frontend && npm install -D vite-plugin-pwa
```

Expected: package.json의 devDependencies에 `vite-plugin-pwa` 추가됨

**Step 2: 설치 확인**

Run:
```bash
ls frontend/node_modules/vite-plugin-pwa/package.json
```

Expected: 파일 존재

**Step 3: 커밋**

```bash
git add frontend/package.json frontend/package-lock.json
git commit -m "chore: vite-plugin-pwa 의존성 추가"
```

---

### Task 2: PWA 아이콘 소스 생성

**Files:**
- Create: `frontend/public/pwa-icon.svg`

**Step 1: SVG 아이콘 작성**

`frontend/public/pwa-icon.svg`에 아래 내용 작성. Amber(#f59e0b) 배경에 흰색 "H" 문자.

```svg
<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
  <rect width="512" height="512" rx="64" fill="#f59e0b"/>
  <text x="256" y="360" font-family="system-ui, -apple-system, sans-serif" font-size="320" font-weight="700" fill="white" text-anchor="middle">H</text>
</svg>
```

**Step 2: 커밋**

```bash
git add frontend/public/pwa-icon.svg
git commit -m "feat: PWA 아이콘 소스 SVG 추가"
```

---

### Task 3: Vite PWA 플러그인 설정

**Files:**
- Modify: `frontend/vite.config.ts`

**Step 1: vite.config.ts에 PWA 플러그인 추가**

`frontend/vite.config.ts` 전체 내용을 아래로 교체:

```ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import tailwindcss from '@tailwindcss/vite'
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    react(),
    tailwindcss(),
    VitePWA({
      registerType: 'autoUpdate',
      includeAssets: ['pwa-icon.svg'],
      manifest: {
        name: 'HomeNRich - AI 가계부',
        short_name: 'HomeNRich',
        description: '자연어로 입력하는 AI 가계부',
        theme_color: '#f59e0b',
        background_color: '#1c1917',
        display: 'standalone',
        start_url: '/',
        scope: '/',
        icons: [
          {
            src: 'pwa-192x192.png',
            sizes: '192x192',
            type: 'image/png',
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png',
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'maskable',
          },
        ],
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff,woff2}'],
        runtimeCaching: [
          {
            urlPattern: /^https?:\/\/.*\/api\/.*/i,
            handler: 'NetworkFirst',
            options: {
              cacheName: 'api-cache',
              expiration: {
                maxEntries: 100,
                maxAgeSeconds: 60 * 60 * 24, // 1일
              },
              cacheableResponse: {
                statuses: [0, 200],
              },
            },
          },
        ],
      },
    }),
  ],
  server: {
    proxy: {
      '/api': 'http://localhost:8000',
    },
  },
})
```

**Step 2: TypeScript 빌드 확인**

Run:
```bash
cd frontend && npx tsc -b
```

Expected: 에러 없이 완료

**Step 3: 커밋**

```bash
git add frontend/vite.config.ts
git commit -m "feat: Vite PWA 플러그인 설정 (generateSW + autoUpdate)"
```

---

### Task 4: index.html 메타태그 업데이트

**Files:**
- Modify: `frontend/index.html`

**Step 1: index.html 전체 내용 교체**

```html
<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/pwa-icon.svg" />
    <link rel="apple-touch-icon" href="/pwa-192x192.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="자연어로 입력하는 AI 가계부" />
    <meta name="theme-color" content="#f59e0b" />
    <title>HomeNRich - AI 가계부</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

변경점:
- `lang="en"` → `lang="ko"`
- favicon → `pwa-icon.svg`
- apple-touch-icon 추가
- description 메타태그 추가
- theme-color 메타태그 추가
- title → "HomeNRich - AI 가계부"

**Step 2: 커밋**

```bash
git add frontend/index.html
git commit -m "feat: index.html PWA 메타태그 + 한국어 lang 설정"
```

---

### Task 5: PWA 아이콘 PNG 생성

**Files:**
- Create: `frontend/public/pwa-192x192.png`
- Create: `frontend/public/pwa-512x512.png`

**Step 1: @vite-pwa/assets-generator로 아이콘 생성**

Run:
```bash
cd frontend && npx @vite-pwa/assets-generator --preset minimal-2023 public/pwa-icon.svg
```

Expected: `public/` 디렉토리에 PNG 아이콘 파일들 생성

만약 assets-generator가 동작하지 않으면, 대안으로 sharp나 다른 도구로 SVG→PNG 변환:
```bash
cd frontend && npx sharp-cli -i public/pwa-icon.svg -o public/pwa-192x192.png resize 192 192
cd frontend && npx sharp-cli -i public/pwa-icon.svg -o public/pwa-512x512.png resize 512 512
```

**Step 2: 생성된 아이콘 확인**

Run:
```bash
ls -la frontend/public/pwa-*.png
```

Expected: 192x192, 512x512 PNG 파일 존재

**Step 3: 커밋**

```bash
git add frontend/public/pwa-*.png
git commit -m "feat: PWA 아이콘 PNG 생성 (192x192, 512x512)"
```

---

### Task 6: Nginx Service Worker 캐싱 설정

**Files:**
- Modify: `frontend/nginx.conf`

**Step 1: SW 캐싱 헤더 추가**

`frontend/nginx.conf`에서 `location /assets/` 블록 뒤에 아래 추가:

```nginx
    # Service Worker — 항상 최신 버전 확인
    location /sw.js {
        add_header Cache-Control "no-cache";
        expires off;
    }

    location /workbox-*.js {
        add_header Cache-Control "no-cache";
        expires off;
    }
```

**Step 2: 커밋**

```bash
git add frontend/nginx.conf
git commit -m "feat: Nginx SW 파일 no-cache 헤더 추가"
```

---

### Task 7: 빌드 검증

**Step 1: 프로덕션 빌드 실행**

Run:
```bash
cd frontend && npm run build
```

Expected: 빌드 성공

**Step 2: SW 파일 생성 확인**

Run:
```bash
ls frontend/dist/sw.js frontend/dist/manifest.webmanifest
```

Expected: 두 파일 모두 존재

**Step 3: manifest 내용 확인**

Run:
```bash
cat frontend/dist/manifest.webmanifest | python3 -m json.tool
```

Expected: name, short_name, icons, theme_color 등 올바르게 포함

---

### Task 8: 기존 테스트 회귀 검증

**Step 1: FE 테스트 실행**

Run:
```bash
cd frontend && npx vitest run
```

Expected: 343개 전체 통과 (기존과 동일)

**Step 2: TypeScript 빌드 확인**

Run:
```bash
cd frontend && npx tsc -b
```

Expected: 에러 없음

**Step 3: 최종 커밋 (필요시)**

변경사항이 있으면:
```bash
git add -A && git commit -m "fix: PWA 설정 후 테스트/빌드 수정"
```

---

### Task 9: 문서 업데이트

**Files:**
- Modify: `docs/IMPLEMENTATION_STATUS.md`

**Step 1: IMPLEMENTATION_STATUS.md에 PWA 항목 추가**

인프라 섹션에 PWA 행 추가:

```markdown
| PWA (오프라인 + 홈 화면) | **완료** | vite-plugin-pwa, 오프라인 앱 셸, 자동 업데이트 |
```

**Step 2: 커밋**

```bash
git add docs/IMPLEMENTATION_STATUS.md
git commit -m "docs: PWA 구현 현황 업데이트"
```
