# 통계/리포트 강화 설계

**날짜**: 2026-02-15
**목표**: 기존 인사이트 페이지를 확장하여 주간/월간/연간 통계 + 기간 비교 기능 제공

---

## 1. 개요

현재 인사이트 페이지는 월간 AI 분석만 제공한다. 이를 확장하여:
- **주간/월간/연간** 기간별 통계 (총액, 카테고리별, 추이)
- **전월 대비** 증감 비교 (금액 + 퍼센트)
- **3개월 트렌드** 비교 차트
- 기존 **AI 인사이트** 유지 (별도 탭)

## 2. 결정 사항

| 항목 | 결정 |
|------|------|
| 위치 | 기존 인사이트 페이지 확장 (라우트 유지) |
| API 설계 | 통합 API 2개 (stats + comparison) |
| 가구/개인 | 현재 방식 유지 (활성 가구 우선, 없으면 개인) |
| AI 인사이트 | 별도 탭으로 유지 (통계와 분리) |
| 비교 기능 | 전월 대비 + 3개월 트렌드 모두 구현 |

## 3. Backend API 설계

### 3-1. `GET /api/expenses/stats`

기존 `/api/expenses/stats/monthly`를 대체하지 않고 새 엔드포인트 추가.

**파라미터**:
- `period`: `"weekly"` | `"monthly"` | `"yearly"` (필수)
- `date`: 기준 날짜 YYYY-MM-DD (선택, 기본값: 오늘)
- `household_id`: 가구 ID (선택)

**응답**:
```json
{
  "period": "monthly",
  "label": "2026년 2월",
  "start_date": "2026-02-01",
  "end_date": "2026-02-28",
  "total": 580000,
  "count": 42,
  "by_category": [
    { "category": "식비", "amount": 320000, "count": 25, "percentage": 55.2 }
  ],
  "trend": [
    { "label": "02/01", "amount": 25000 },
    { "label": "02/02", "amount": 18000 }
  ]
}
```

**기간별 동작**:
- `weekly`: start/end = 해당 주 월~일, trend = 일별 7개 포인트, label = "2월 3주차"
- `monthly`: start/end = 해당 월 1일~말일, trend = 일별 28~31개 포인트, label = "2026년 2월"
- `yearly`: start/end = 해당 연도 1/1~12/31, trend = 월별 12개 포인트, label = "2026년"

### 3-2. `GET /api/expenses/stats/comparison`

**파라미터**:
- `period`: `"monthly"` | `"yearly"` (필수)
- `date`: 기준 날짜 (선택, 기본값: 오늘)
- `months`: 비교할 개월 수 (선택, 기본값: 3)
- `household_id`: 가구 ID (선택)

**응답**:
```json
{
  "current": { "label": "2026년 2월", "total": 580000 },
  "previous": { "label": "2026년 1월", "total": 620000 },
  "change": { "amount": -40000, "percentage": -6.5 },
  "trend": [
    { "label": "2025년 12월", "total": 550000 },
    { "label": "2026년 1월", "total": 620000 },
    { "label": "2026년 2월", "total": 580000 }
  ],
  "by_category_comparison": [
    {
      "category": "식비",
      "current": 320000,
      "previous": 350000,
      "change_amount": -30000,
      "change_percentage": -8.6
    }
  ]
}
```

## 4. Frontend UI 설계

### 4-1. 탭 구조

```
[ 주간 ] [ 월간 ] [ 연간 ] [ AI 인사이트 ]
```

### 4-2. 공통 레이아웃 (주간/월간/연간 탭)

```
┌─────────────────────────────────────────┐
│  ◀  2026년 2월  ▶       [기간 네비게이션]│
├─────────────────────────────────────────┤
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐  │
│  │총 지출│ │전월대비│ │건 수 │ │일평균 │  │
│  │₩58만 │ │▼6.5% │ │42건  │ │₩2.1만│  │
│  └──────┘ └──────┘ └──────┘ └──────┘  │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │       추이 차트 (Line)           │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │    3개월 비교 (Bar Chart)        │   │
│  └─────────────────────────────────┘   │
│                                         │
│  카테고리별 지출 (+ 전월 대비 변화)     │
│  ┌─────────────────────────────────┐   │
│  │ 식비  ████████████ ₩32만  ▼8.6% │   │
│  │ 교통  ████         ₩8만  ▲12%   │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

### 4-3. 탭별 차이

| 탭 | 기간 네비게이션 | 추이 X축 | 비교 차트 |
|----|----------------|----------|----------|
| 주간 | ◀ 2월 3주차 ▶ | 월~일 (7일) | 없음 |
| 월간 | ◀ 2026년 2월 ▶ | 1일~말일 | 최근 3개월 막대 |
| 연간 | ◀ 2026년 ▶ | 1월~12월 | 전년 대비 |

### 4-4. 변화량 표시 규칙 (5단계)

| 변화율 | 표시 | 색상 | 아이콘 |
|--------|------|------|--------|
| +20% 이상 | 많이 늘음 | `rose-600` | ▲▲ |
| +5% ~ +20% | 조금 늘음 | `rose-400` | ▲ |
| -5% ~ +5% | 보통 | `stone-400` | ─ |
| -20% ~ -5% | 줄음 | `emerald-400` | ▼ |
| -20% 미만 | 많이 줄음 | `emerald-600` | ▼▼ |

지출 기준이므로 증가=경고(빨강), 감소=긍정(초록).

### 4-5. AI 인사이트 탭

기존 인사이트 페이지 코드 그대로 유지:
- 월 선택 + "분석하기" 버튼
- LLM 기반 마크다운 인사이트 표시

## 5. 컴포넌트 구조

```
frontend/src/
├── pages/InsightsPage.tsx          (탭 컨테이너로 리디자인)
├── components/stats/
│   ├── StatsSummaryCards.tsx        (요약 카드 4개)
│   ├── TrendChart.tsx              (추이 라인차트)
│   ├── ComparisonChart.tsx         (3개월 비교 바차트)
│   ├── CategoryBreakdown.tsx       (카테고리별 프로그레스바 + 변화량)
│   ├── ChangeIndicator.tsx         (5단계 변화량 표시 컴포넌트)
│   └── PeriodNavigator.tsx         (◀ 기간 ▶ 네비게이션)
```

## 6. 파일 변경 범위

### Backend
- **수정**: `backend/app/api/expenses.py` — stats, comparison 엔드포인트 추가
- **수정**: `backend/app/schemas/expense.py` — StatsResponse, ComparisonResponse 스키마
- **신규**: `backend/tests/integration/test_api_stats.py` — 통계 API 테스트

### Frontend
- **수정**: `frontend/src/pages/InsightsPage.tsx` — 탭 구조로 리디자인
- **수정**: `frontend/src/api/insights.ts` — stats/comparison API 호출 추가
- **수정**: `frontend/src/types/index.ts` — 새 타입 정의
- **신규**: `frontend/src/components/stats/*.tsx` — 6개 컴포넌트

### 기존 호환성
- `GET /api/expenses/stats/monthly` 유지 (대시보드에서 사용 중)
- 새 엔드포인트는 별도 경로로 추가

## 7. 테스트 계획

| 영역 | 테스트 수 | 내용 |
|------|-----------|------|
| BE 통계 API | 10~15개 | 기간별 조회, 빈 데이터, 경계값, 가구 필터 |
| BE 비교 API | 5~8개 | 전월 비교, 3개월 트렌드, 데이터 없는 월 |
| FE 컴포넌트 | 15~20개 | 탭 전환, 차트 렌더링, 변화량 표시, 기간 네비게이션 |
