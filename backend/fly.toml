# Fly.io 배포 설정 - Backend
# 문서: https://fly.io/docs/reference/configuration/

app = "podo-budget-backend"
primary_region = "nrt"  # 도쿄 (Tokyo Narita)

# 자동 중지 방지 (무료 티어에서는 비활성 시 중지됨)
# 유료 플랜 전환 시 주석 해제
# kill_signal = "SIGINT"
# kill_timeout = "5s"

[build]

[deploy]
  release_command = "sh -c 'uv sync --frozen --no-dev --no-install-project && .venv/bin/alembic upgrade head'"

[env]
  PORT = "8000"
  APP_NAME = "HomeNRich"
  DEBUG = "False"
  DATABASE_URL = "sqlite+aiosqlite:////app/data/db.sqlite3"

[http_service]
  internal_port = 8000
  force_https = true
  auto_stop_machines = false  # 자동 중지 비활성화 — 콜드 스타트 무한 리다이렉트 방지
  auto_start_machines = true
  min_machines_running = 1    # 항상 1대 유지

  [[http_service.checks]]
    grace_period = "10s"
    interval = "30s"
    method = "GET"
    timeout = "5s"
    path = "/health"

# 무료 티어: shared-cpu-1x + 256MB
[[vm]]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 512

[[mounts]]
  source = "budget_data"
  destination = "/app/data"

# 유료 플랜 전환 시 (고성능 필요하면)
# [[vm]]
#   cpu_kind = "shared"
#   cpus = 2
#   memory_mb = 1024

# Auto-scaling (유료 플랜에서만)
# [[services]]
#   http_checks = []
#   internal_port = 8000
#   processes = ["app"]
#   protocol = "tcp"
#   script_checks = []
#
#   [services.concurrency]
#     hard_limit = 250
#     soft_limit = 200
#     type = "connections"
#
#   [[services.ports]]
#     force_https = true
#     handlers = ["http"]
#     port = 80
#
#   [[services.ports]]
#     handlers = ["tls", "http"]
#     port = 443
